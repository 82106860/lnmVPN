#!/sbin/iptables
#
# +-----------------------------------------------------------------------+
# |       Author: Cheng Wenfeng   <277546922@qq.com>                      |
# +-----------------------------------------------------------------------+
#
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:Policy_Route - [0:0]
#
-A PREROUTING -m comment --comment "set MARK RECORD" -j Policy_Route
#

-A Policy_Route  -m set --match-set advroute_dst_12 dst -j MARK --set-mark 100012
-A Policy_Route  -m set --match-set advroute_dst_12 dst -j RETURN
-A Policy_Route   -j MARK --set-mark 100014
-A Policy_Route   -j RETURN
#
# MAX MTU LIMIT
#-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1400:65535 -j TCPMSS --clamp-mss-to-pmtu
#
COMMIT
#
#
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
#
#
# DNS PROXY
-A PREROUTING -p udp -m udp --dport 53 -m comment --comment "DNSPROXY" -j REDIRECT --to-ports 53
#
# NAT RULE
-A POSTROUTING -m set --match-set natrule_src_4 src -m set  --match-set natrule_dst_4 dst -j SNAT --to 192.168.60.188
-A POSTROUTING -m set --match-set natrule_src_5 src -m set ! --match-set natrule_dst_5 dst -o eth0 -j MASQUERADE

#
# VPN Nat[弃用]
#{{vpnpolicyzoneA}}
#
# SNAT 
#
#
COMMIT
#
#
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:vpnpolicy_100026 - [0:0]
:vpnpolicy_100033 - [0:0]

#
# Localhost
-A INPUT -i lo -j ACCEPT
#
#ICMP
-A INPUT -p icmp -j ACCEPT
#
#LocalNET
-A INPUT -m set --match-set localnet src -j ACCEPT
# MAX MTU LIMIT
-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1400:65535 -j TCPMSS --clamp-mss-to-pmtu
#
# VPN RULE
#-A INPUT -p gre -j ACCEPT
#-A INPUT -i tun+ -j ACCEPT
#-A INPUT -i tap+ -j ACCEPT
#-A FORWARD -p gre -j ACCEPT
#-A FORWARD -i tun+ -j ACCEPT
#-A FORWARD -i tap+ -j ACCEPT
# DHCP Service
-A INPUT -p udp --dport 67:68 -j ACCEPT
# DNS Port
-A INPUT -p tcp -m set --match-set dnsport dst -j ACCEPT
-A INPUT -p udp -m set --match-set dnsport dst -j ACCEPT
#
# APP Port
-A INPUT -p tcp -m set --match-set vpnport dst -j ACCEPT
-A INPUT -p udp -m set --match-set vpnport dst -j ACCEPT
# SystemPort
-A INPUT -p tcp -m set --match-set system_port dst -j ACCEPT
#
# VPN Policy
-A FORWARD -m set --match-set vpnpolicy_src_100026 src -j vpnpolicy_100026
-A vpnpolicy_100026 -m set --match-set vpnpolicy_net_100026 dst -j ACCEPT
-A vpnpolicy_100026 -j DROP
-A FORWARD -m set --match-set vpnpolicy_src_100033 src -j vpnpolicy_100033
-A vpnpolicy_100033 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A vpnpolicy_100033 -m set --match-set vpnpolicy_local_100033 dst -j DROP
-A vpnpolicy_100033 -j ACCEPT

#
# UTM Rule
-A INPUT  -m multiport -p tcp --dport 889 -j ACCEPT
-A INPUT  -m multiport -p tcp --dport 9001 -j ACCEPT

#
# Allow ESTABLISHED 
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
#
# SYSTEM
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited 
#
COMMIT
